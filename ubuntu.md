# Развертывание сервера на Linux
В статье будет рассмотрен дистрибулив Linux Ubuntu 20.04

## Начальная настройка сервера

### Создание нового пользователя
После входа в систему с правами root мы готовы добавить новую учетную запись пользователя. В будущем мы выполним вход с помощью этой новой учетной записи, а не с правами root.

```bash
# adduser popov
```

### Предоставление административных прав

Чтобы не выполнять выход из стандартной учетной записи и выполнять вход в систему с учетной записью root, мы можем настроить так называемого суперпользователя или добавить привилегии root для стандартной учетной записи. Это позволит нашему обычному пользователю запускать команды с правами администратора, указав слово sudo перед каждой командой.

Чтобы добавить эти права для нового пользователя, нам нужно добавить пользователя в группу sudo. По умолчанию в Ubuntu 20.04 пользователи, входящие в группу sudo могут использовать команду `sudo`.

Используя права root, запустите эту команду, чтобы добавить нового пользователя в группу sudo (замените выделенное имя пользователя на нового пользователя):

```bash
usermod -aG sudo popov
```

Теперь, когда вы войдете в систему со стандартным пользователем, вы можете ввести sudo перед командами для выполнения действий с правами суперпользователя.

Подробнее об управении пльзователями в Linux https://www.digitalocean.com/community/tutorials/how-to-add-and-delete-users-on-ubuntu-18-04

### Настройка базового брандмауэра
Серверы Ubuntu 20.04 могут использовать брандмауэр UFW для проверки, что подключения разрешены только к определенным службам. Мы можем легко настроить базовый брандмауэр с помощью приложения.

Приложения могут регистрировать свои профили в UFW после установки. Эти профили позволяют UFW управлять этими приложениями по имени. OpenSSH, служба, позволяющая подключиться к нашему серверу сейчас, имеет профиль, зарегистрированный в UFW.

Чтобы увидеть это, можно ввести следующую команду:

```bash
sudo ufw app list
```

Нам нужно убедиться в том, что брандмауэр разрешает подключения SSH, чтобы мы могли выполнить вход в следующий раз. Чтобы разрешить эти подключения, можно ввести следующее:

```bash
sudo ufw allow OpenSSH
```
После этого мы можем активировать брандмауэр с помощью следующей команды:

```bash
sudo ufw enable
```

Поскольку брандмауэр в настоящее время блокирует все подключения, кроме SSH, если вы установите и настроите дополнительные службы, потребуется изменить настройки брандмауэра, чтобы разрешить входящий трафик.

Срару откроем нужные нам порты 8080 и 5432, на которых будут работать нужные нам сервисы: Apache AirFlow и внешний доступ (не секьюрно!) к PostgreSQL.

```bash
sudo ufw allow 8080 5432
```
### Активация внешнего доступа

Для доступа по ssh-ключу ([как создать ключи доступа](https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-20-04)) нужно скопировать публичный ключ на сервер. Для этого нужно выполнить следующее на локальной машине:

```bash
cat ~/id_rsa.pub | ssh your_name@your_ip "mkdir -p ~/.ssh && touch ~/.ssh/authorized_keys && chmod -R go= ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

Поправим в конфиге

```bash
sudo nano /etc/ssh/sshd_config
```

строку  `PasswordAuthentication no`

Перезагрузим сервис

```bash
sudo systemctl restart ssh
```

### Добавление области подкачки

Можно узнать, сконфигурирована ли в системе подкачка, введя:

```bash
sudo swapon --show
```
Если после этой команды ничего не появляется, в системе сейчас нет области подкачки.

Можно убедиться в отсутствии активной подкачки при помощи утилиты free:

```bash
free -h
```

Перед созданием файла подкачки проверим текущее состояние диска, чтобы убедиться, что у нас достаточно места. Вводим:

```bash
df -h
```

Хотя существует много мнений относительно правильного размера области подкачки, на самом деле он зависит от ваших личных предпочтений и требований приложений. Обычно можно начать с объема, равного объему оперативной памяти в системе, или в два раза большего. Еще одно полезное общее правило — любое превышение 4 Гбайт для области подкачки, скорее всего, не нужно, если вы используете ее только для резервирования оперативной памяти.

Теперь, когда известно свободное место на жестком диске, можно создать файл подкачки в нашей файловой системе. Мы добавим файл необходимого размера под названием `swapfile` в корневую (`/`) директорию.

Лучше всего создавать файл подкачки при помощи программы `fallocate`. Эта команда мгновенно создает файл указанного размера.

Поскольку на сервере в нашем случае 1 Гбайт оперативной памяти, в этом руководстве создадим файл размером 1 Гбайт. Скорректируйте с учетом необходимости на вашем сервере:

```bash
sudo fallocate -l 1G /swapfile
```
Чтобы проверить правильность выделенного объема памяти, введите:

```bash
ls -lh /swapfile
```
Теперь, когда у нас есть файл правильного размера, нам нужно превратить его в пространство подкачки.

Сначала нужно изменить права доступа к файлу, чтобы только пользователи с правами root могли читать его содержимое. Это предотвращает доступ обычных пользователей к файлу — такой доступ может существенно влиять на безопасность.

Чтобы передать все права доступа пользователям root, введите:

```bash
sudo chmod 600 /swapfile
```
Проверьте изменение прав доступа, введя следующее:

```bash
ls -lh /swapfile
```
Теперь можем отметить файл как пространство подкачки, введя следующее:

```bash
sudo mkswap /swapfile
```
После этого мы можем активировать файл подкачки, чтобы система могла его использовать:

```bash
sudo swapon /swapfile
```
Убедитесь, что пространство подкачки активировано, введя следующее:

```bash
udo swapon --show
```

В результате внесенных нами изменений файл подкачки активирован для текущей сессии. После перезагрузки сервер не сохранит настройки подкачки автоматически. Мы можем изменить это, добавив файл подкачки к файлу `/etc/fstab`. Сделайте резервную копию файла `/etc/fstab` на случай если что-то пойдет не так:

```bash
sudo cp /etc/fstab /etc/fstab.bak
```

Добавьте информацию о файле подкачки в конец файла `/etc/fstab`, введя следующее:

```bash
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

Подробнее об области подкачи в Ubuntu https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-20-04-ru

## Установка и настройка приложений

### Установка и использование PostgreSQL

Если вы еще не сделали этого, обновите локальный индекс пакетов вашего сервера:

```bash
sudo apt update
```
После этого установите пакет Postgres вместе с пакетом `-contrib`, который содержит дополнительные утилиты и функциональные возможности:

```bash
sudo apt install postgresql postgresql-contrib
```
По умолчанию Postgres использует концепцию «ролей» для выполнения аутентификации и авторизации. В некоторых аспектах они напоминают обычные учетные записи в Unix, однако Postgres не делает различий между пользователями и группами и предпочитает использовать более гибкий термин «роль».

После установки Postgres настроена на использование аутентификации ident, что значит, что выполняется привязка ролей Postgres с соответствующей системной учетной записью Unix/Linux. Если роль существует внутри Postgres, пользователь Unix/Linux с тем же именем может выполнить вход в качестве этой роли.

В ходе установки была создана учетную запись пользователя postgres, которая связана с используемой по умолчанию ролью Postgres. Чтобы использовать Postgres, вы можете войти в эту учетную запись.

Существует несколько способов использования этой учетной записи для доступа к Postgres.

Вы можете переключиться на учетную запись postgres на вашем сервере с помощью следующей команды:

```bash
sudo -i -u postgres
```

Теперь вы можете немедленно получить доступ к командной строке PostgresSQL с помощью следующей команды:

```bash
psql
```
К настоящему моменту у вас есть только роль postgres, настроенная внутри базы данных. Вы можете создавать новые роли из командной строки с командой `createrole`. Флаг `--interactive` будет запрашивать имя новой роли, а также попросит указать, будут ли у этой роли права суперпользователя.

```bash
sudo -u postgres createuser --interactive
```

Еще одно предположение, которое система аутентификации Postgres использует по умолчанию, состоит в том, что для любой роли, используемой для входа, существует база данных с тем же именем, к которой роль может получить доступ.

Это означает, что если созданный вами в последнем разделе пользователь будет иметь имя popov, эта роль попытается подключиться к базе данных, которая также называется «popov» по умолчанию. Вы можете создать соответствующую базу данных с помощью команды `createdb`.

```bash
sudo -u postgres createdb popov
```

Чтобы выполнить аутентификацию с помощью ident, вам потребуется пользователь Linux с тем же именем, что и имя роли и базы данных в Postgres.

```bash
sudo -u popov psql
```
Эта команда позволит выполнить вход автоматически, полагая, что все компоненты были настроены должным образом.

Если вы хотите, чтобы ваш пользователь подключился к другой базе данных, то вы можете сделать это с помощью следующей команды:

```bash
psql -d postgres
```
О создании и управлении таблицами в Postgres можно узнать здесь https://www.digitalocean.com/community/tutorials/how-to-create-remove-manage-tables-in-postgresql-on-a-cloud-server

Чтобы открыть доступ извне (что крайне не рекомендуется в целях безопасности) нужно отредактировать пару конфигов.

```
postgres=# SHOW config_file;
postgres=# SHOW hba_file;
```

В первом раскоментируем строчку `listen_addresses = '*'`
Во втором добавляем две строки:
```
host    all             all              0.0.0.0/0                       md5
host    all             all              ::/0                            md5
```
Затем перезагружаем сервис

```bash
sudo service postgresql restart
```

### Русскоязычная локаль

Необходимая локаль (locale) — ru_RU.utf8. Её и надо установить:

```bash
sudo apt-get install language-pack-ru
sudo update-locale LANG=ru_RU.UTF-8
```

